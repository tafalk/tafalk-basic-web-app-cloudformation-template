Description:
  This template deploys Datasources for the app

Parameters:
  ProjectIdentifierName:
    Type: String
  EnvironmentName:
    Type: String
  ApprovalDbClusterIdentifier:
    Type: String
  ApprovalDbName:
    Type: String
  AuroraMysqlEngineVersion:
    Type: String
  AuroraMysqlMasterUsername:
    Type: String
  AuroraMysqlMasterUserPassword:
    Type: String
  AuroraMysqlDBSubnetGroupNames:
    Type: CommaDelimitedList

Resources:
  # DynamoDb
  UserTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${EnvironmentName}_Users
      BillingMode: PROVISIONED
      AttributeDefinitions:
        - AttributeName: "id"
          AttributeType: "S"
        - AttributeName: "username"
          AttributeType: "S"
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: username-index
          KeySchema:
            - AttributeName: username
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1
      Tags:
        - Key: Name
          Value: Users
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Application
          Value: !Ref ProjectIdentifierName

  CantoTable:
    DependsOn: UserTable
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${EnvironmentName}_Cantos
      BillingMode: PROVISIONED
      AttributeDefinitions:
        - AttributeName: "id"
          AttributeType: "S"
        - AttributeName: "status"
          AttributeType: "S"
        - AttributeName: "lastUpdateTime"
          AttributeType: "S"
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: status-lastUpdateTime-index
          KeySchema:
            - AttributeName: status
              KeyType: HASH
            - AttributeName: lastUpdateTime
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1
      Tags:
        - Key: Name
          Value: Streams
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Application
          Value: !Ref ProjectIdentifierName

  StreamTable:
    DependsOn: CantoTable
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${EnvironmentName}_Streams
      BillingMode: PROVISIONED
      AttributeDefinitions:
        - AttributeName: "id"
          AttributeType: "S"
        - AttributeName: "userId"
          AttributeType: "S"
        - AttributeName: "isSealed"
          AttributeType: "N"
        - AttributeName: "startTime"
          AttributeType: "S"
        - AttributeName: "sealTime"
          AttributeType: "S"
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: userId-index
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1
        - IndexName: isSealed-sealTime-index
          KeySchema:
            - AttributeName: isSealed
              KeyType: HASH
            - AttributeName: sealTime
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1
        - IndexName: isSealed-startTime-index
          KeySchema:
            - AttributeName: isSealed
              KeyType: HASH
            - AttributeName: startTime
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1
      Tags:
        - Key: Name
          Value: Streams
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Application
          Value: !Ref ProjectIdentifierName

  UserInteractionTable:
    DependsOn: StreamTable
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${EnvironmentName}_UserInteractions
      BillingMode: PROVISIONED
      AttributeDefinitions:
        - AttributeName: "id"
          AttributeType: "S"
        - AttributeName: "targetUserId"
          AttributeType: "S"
        - AttributeName: "actorUserId"
          AttributeType: "S"
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: targetUserId-index
          KeySchema:
            - AttributeName: targetUserId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1
        - IndexName: actorUserId-index
          KeySchema:
            - AttributeName: actorUserId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1
      Tags:
        - Key: Name
          Value: UserInteractions
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Application
          Value: !Ref ProjectIdentifierName

  CommentTable:
    DependsOn: UserInteractionTable
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${EnvironmentName}_Comments
      BillingMode: PROVISIONED
      AttributeDefinitions:
        - AttributeName: "id"
          AttributeType: "S"
        - AttributeName: "streamId"
          AttributeType: "S"
        - AttributeName: "userId"
          AttributeType: "S"
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: streamId-index
          KeySchema:
            - AttributeName: streamId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1
        - IndexName: userId-index
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1
      Tags:
        - Key: Name
          Value: Comments
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Application
          Value: !Ref ProjectIdentifierName

  LikeTable:
    DependsOn: CommentTable
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${EnvironmentName}_Likes
      BillingMode: PROVISIONED
      AttributeDefinitions:
        - AttributeName: "id"
          AttributeType: "S"
        - AttributeName: "streamId"
          AttributeType: "S"
        - AttributeName: "cantoId"
          AttributeType: "S"
        - AttributeName: "userId"
          AttributeType: "S"
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: streamId-index
          KeySchema:
            - AttributeName: streamId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1
        - IndexName: cantoId-index
          KeySchema:
            - AttributeName: cantoId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1
        - IndexName: userId-index
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1
      Tags:
        - Key: Name
          Value: Likes
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Application
          Value: !Ref ProjectIdentifierName

  # DBSubnet Group
  ApprovalDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Approval DB Subnet Group
      SubnetIds: !Ref AuroraMysqlDBSubnetGroupNames
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Application
          Value: !Ref ProjectIdentifierName

  # Serverless Aurora DB Cluster
  ApprovalDbCluster:
    Type: AWS::RDS::DBCluster
    Properties:
      Engine: aurora
      EngineMode: serverless
      EngineVersion: !Ref AuroraMysqlEngineVersion
      DatabaseName: !Ref ApprovalDbName
      MasterUsername: !Ref AuroraMysqlMasterUsername
      MasterUserPassword: !Ref AuroraMysqlMasterUserPassword
      DBClusterIdentifier: !Ref ApprovalDbClusterIdentifier
      BackupRetentionPeriod: 35
      DeletionProtection: false
      EnableHttpEndpoint: true
      ScalingConfiguration:
        AutoPause: true
        MaxCapacity: 8
        MinCapacity: 2
        SecondsUntilAutoPause: 300
      DBSubnetGroupName: !Ref ApprovalDBSubnetGroup
      Tags:
        - Key: Name
          Value: Approval
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Application
          Value: !Ref ProjectIdentifierName

Outputs:
  # DynamoDB
  UserTable:
    Description: A reference to the created UserTable
    Value: !Ref UserTable
  CantoTable:
    Description: A reference to the created CantoTable
    Value: !Ref CantoTable
  StreamTable:
    Description: A reference to the created StreamTable
    Value: !Ref StreamTable
  UserInteractionTable:
    Description: A reference to the created UserInteractionTable
    Value: !Ref UserInteractionTable
  CommentTable:
    Description: A reference to the created CommentTable
    Value: !Ref CommentTable
  LikeTable:
    Description: A reference to the created LikeTable
    Value: !Ref LikeTable
  UserTableArn:
    Description: A reference to the created UserTable ARN
    Value: !GetAtt UserTable.Arn
  CantoTableArn:
    Description: A reference to the created CantoTable ARN
    Value: !GetAtt CantoTable.Arn
  StreamTableArn:
    Description: A reference to the created StreamTable ARN
    Value: !GetAtt StreamTable.Arn
  UserInteractionTableArn:
    Description: A reference to the created UserInteractionTable ARN
    Value: !GetAtt UserInteractionTable.Arn
  CommentTableArn:
    Description: A reference to the created CommentTable ARN
    Value: !GetAtt CommentTable.Arn
  LikeTableArn:
    Description: A reference to the created LikeTable ARN
    Value: !GetAtt LikeTable.Arn
  # Relational
  ApprovalDbCluster:
    Description: A reference to the created ApprovalDbCluster i.e. its name
    Value: !Ref ApprovalDbCluster
  ApprovalDbClusterEndpointAddress:
    Description: A reference to the created ApprovalDbCluster endpoint address
    Value: !GetAtt ApprovalDbCluster.Endpoint.Address
  ApprovalDbClusterEndpointPort:
    Description: A reference to the created ApprovalDbCluster endpoint port
    Value: !GetAtt ApprovalDbCluster.Endpoint.Port

