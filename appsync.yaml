Description: GraphQl API
Parameters:
  ProjectIdentifierName:
    Type: String
  EnvironmentName:
    Type: String
  ResourceBucketName:
    Type: String
  AppSyncLogRoleArn:
    Type: String
  AppSyncResourceDynamoDbRoleArn:
    Type: String
  AppSyncResourceAuroraRoleArn:
    Type: String
  AppSyncResourceLambdaRoleArn:
    Type: String
  UserTableName:
    Type: String
  CantoTableName:
    Type: String
  StreamTableName:
    Type: String
  UserInteractionTableName:
    Type: String
  LikeTableName:
    Type: String
  CommentTableName:
    Type: String
  ApprovalDbClusterIdentifier:
    Type: String
  AuroraMysqlAppCredentialSecretStoreArn:
    Type: String
  ResourceSearcherFunctionArn:
    Type: String
  RecaptchaTokenResolverFunctionArn:
    Type: String

Resources:
  # A P I
  AppSyncApi:
    Type: AWS::AppSync::GraphQLApi
    Properties:
      Name: !Sub "${ProjectIdentifierName}-${EnvironmentName}-appsync-api"
      AuthenticationType: API_KEY
      # UserPoolConfig: UserPoolConfig
      # OpenIDConnectConfig : OpenIDConnectConfig
      LogConfig:
        FieldLogLevel: ERROR
        CloudWatchLogsRoleArn: !Ref AppSyncLogRoleArn

  # S C H E M A
  AppSyncSchema:
    Type: AWS::AppSync::GraphQLSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      DefinitionS3Location: !Sub "s3://${ResourceBucketName}/graphql/schema-20191112-1.graphql"

  # D A T A   S O U R C E S
  AppSyncUserTableDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      Name: user_ds
      Description: "The User Table AppSync Data Source"
      Type: AMAZON_DYNAMODB
      ServiceRoleArn: !Ref AppSyncResourceDynamoDbRoleArn
      DynamoDBConfig:
        TableName: !Ref UserTableName
        AwsRegion: !Sub ${AWS::Region}

  AppSyncCantoTableDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      Name: cantos_ds
      Description: "The Canto Table AppSync Data Source"
      Type: AMAZON_DYNAMODB
      ServiceRoleArn: !Ref AppSyncResourceDynamoDbRoleArn
      DynamoDBConfig:
        TableName: !Ref CantoTableName
        AwsRegion: !Sub ${AWS::Region}

  AppSyncStreamTableDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      Name: stream_ds
      Description: "The Stream Table AppSync Data Source"
      Type: AMAZON_DYNAMODB
      ServiceRoleArn: !Ref AppSyncResourceDynamoDbRoleArn
      DynamoDBConfig:
        TableName: !Ref StreamTableName
        AwsRegion: !Sub ${AWS::Region}

  AppSyncUserInteractionTableDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      Name: user_interaction_ds
      Description: "The UserInteraction Table AppSync Data Source"
      Type: AMAZON_DYNAMODB
      ServiceRoleArn: !Ref AppSyncResourceDynamoDbRoleArn
      DynamoDBConfig:
        TableName: !Ref UserInteractionTableName
        AwsRegion: !Sub ${AWS::Region}

  AppSyncLikeTableDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      Name: like_ds
      Description: "The Like Table AppSync Data Source"
      Type: AMAZON_DYNAMODB
      ServiceRoleArn: !Ref AppSyncResourceDynamoDbRoleArn
      DynamoDBConfig:
        TableName: !Ref LikeTableName
        AwsRegion: !Sub ${AWS::Region}

  AppSyncCommentTableDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      Name: comment_ds
      Description: "The Comment Table AppSync Data Source"
      Type: AMAZON_DYNAMODB
      ServiceRoleArn: !Ref AppSyncResourceDynamoDbRoleArn
      DynamoDBConfig:
        TableName: !Ref CommentTableName
        AwsRegion: !Sub ${AWS::Region}

  AppSyncApprovalDbDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      Name: approval_ds
      Description: "The ApprovalDB AppSync Data Source"
      Type: RELATIONAL_DATABASE
      ServiceRoleArn: !Ref AppSyncResourceAuroraRoleArn
      RelationalDatabaseConfig:
        RelationalDatabaseSourceType: RDS_HTTP_ENDPOINT
        RdsHttpEndpointConfig:
          AwsRegion: !Sub ${AWS::Region}
          DbClusterIdentifier: !Ref ApprovalDbClusterIdentifier
          AwsSecretStoreArn: !Ref AuroraMysqlAppCredentialSecretStoreArn

  AppSyncResourceSearcherFunctionDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      Name: resource_searcher_ds
      Description: "The Resource-Searcher Function AppSync Data Source"
      Type:  AWS_LAMBDA
      ServiceRoleArn: !Ref AppSyncResourceLambdaRoleArn
      LambdaConfig:
        LambdaFunctionArn: !Ref ResourceSearcherFunctionArn

  AppSyncRecaptchaTokenResolverFunctionDataSource:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      Name: recaptcha_token_resolver_ds
      Description: "The Recaptcha-Token-Resolver Function AppSync Data Source"
      Type:  AWS_LAMBDA
      ServiceRoleArn: !Ref AppSyncResourceLambdaRoleArn
      LambdaConfig:
        LambdaFunctionArn: !Ref RecaptchaTokenResolverFunctionArn

  # R E S O L V E R S
  # Query
  GetUserByUsernameResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: getUserByUsername
      DataSourceName: !GetAtt AppSyncUserTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/getUserByUsername.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnList.resp.vm"

  ListStreamsByUserResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: listStreamsByUser
      DataSourceName: !GetAtt AppSyncStreamTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/listStreamsByUser.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  ListLikesByUserResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: listLikesByUser
      DataSourceName: !GetAtt AppSyncLikeTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/listLikesByUser.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  ListUserInteractionsByActorUserIdIndexResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: listUserInteractionsByActorUserIdIndex
      DataSourceName: !GetAtt AppSyncUserInteractionTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/listUserInteractionsByActorUserIdIndex.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  GetStreamResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: getStream
      DataSourceName: !GetAtt AppSyncStreamTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/getStream.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  ListSealedStreamsResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: listSealedStreams
      DataSourceName: !GetAtt AppSyncStreamTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/listSealedStreams.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  ListLiveStreamsResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: listLiveStreams
      DataSourceName: !GetAtt AppSyncStreamTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/listLiveStreams.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  QueryUserInteractionsBetweenUsersByUserIdIndicesResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: queryUserInteractionsBetweenUsersByUserIdIndices
      DataSourceName: !GetAtt AppSyncUserInteractionTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/queryUserInteractionsBetweenUsersByUserIdIndices.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnList.resp.vm"

  ListStreamLikesResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: listStreamLikes
      DataSourceName: !GetAtt AppSyncLikeTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/listStreamLikes.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnList.resp.vm"

  ListContentFlagsResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: listFlags
      DataSourceName: !GetAtt AppSyncApprovalDbDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/listFlags.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/returnList.resp.vm"

  ListCantoLikesResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: listCantoLikes
      DataSourceName: !GetAtt AppSyncLikeTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/listCantoLikes.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnList.resp.vm"

  ListPaginatedStreamCommentsResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: listPaginatedStreamComments
      DataSourceName: !GetAtt AppSyncCommentTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/listPaginatedStreamComments.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  SearchResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: search
      DataSourceName: !GetAtt AppSyncResourceSearcherFunctionDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/lambda.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/search.resp.vm"

  GetRecaptchaTokenResultResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: getRecaptchaTokenResult
      DataSourceName: !GetAtt AppSyncRecaptchaTokenResolverFunctionDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/lambda.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/lambda.resp.vm"

  ListUncloggerPromptsResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: listUncloggerPrompts
      DataSourceName: !GetAtt AppSyncApprovalDbDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/listUncloggerPrompts.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/returnList.resp.vm"

  # Cantos
  ListCantosResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: listCantos
      DataSourceName: !GetAtt AppSyncCantoTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/listPaginatedCantos.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  GetCantoResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: getCanto
      DataSourceName: !GetAtt AppSyncCantoTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/getById.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  # Mutations
  UpdateUserResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: updateUser
      DataSourceName: !GetAtt AppSyncUserTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/update.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  DeleteUserResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: deleteUser
      DataSourceName: !GetAtt AppSyncUserTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/deleteInputId.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  CreateStreamResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: createStream
      DataSourceName: !GetAtt AppSyncStreamTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/createInputIdItem.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  UpdateStreamResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: updateStream
      DataSourceName: !GetAtt AppSyncStreamTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/update.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  CreateCantoResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: createCanto
      DataSourceName: !GetAtt AppSyncCantoTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/createInputIdItem.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  UpdateCantoResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: updateCanto
      DataSourceName: !GetAtt AppSyncCantoTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/update.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  CreateUserInteractionResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: createUserInteraction
      DataSourceName: !GetAtt AppSyncUserInteractionTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/createUserInteraction.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  DeleteUserInteractionResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: deleteUserInteraction
      DataSourceName: !GetAtt AppSyncUserInteractionTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/deleteInputId.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  CreateLikeResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: createLike
      DataSourceName: !GetAtt AppSyncLikeTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/createAutoIdItem.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  UpdateLikeIndicesResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: updateLikeIndices
      DataSourceName: !GetAtt AppSyncLikeTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/update.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  DeleteLikeResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: deleteLike
      DataSourceName: !GetAtt AppSyncLikeTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/deleteInputId.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  CreateCommentResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: createComment
      DataSourceName: !GetAtt AppSyncCommentTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/createAutoIdItem.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  CreateFlagResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: createFlag
      DataSourceName: !GetAtt AppSyncApprovalDbDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/createFlag.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/returnSecondSingleItem.resp.vm"

  UpdateFlagContentResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: updateFlagContent
      DataSourceName: !GetAtt AppSyncApprovalDbDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/updateFlagContent.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/returnSecondSingleItem.resp.vm"

  UpdateFlagReviewResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: updateFlagReview
      DataSourceName: !GetAtt AppSyncApprovalDbDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/updateFlagReviewer.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/returnSecondSingleItem.resp.vm"

  DeleteFlagResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: deleteFlag
      DataSourceName: !GetAtt AppSyncApprovalDbDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/deleteFlag.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/returnFirstSingleItem.resp.vm"

  CreateUncloggerPromptResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: createUncloggerPrompt
      DataSourceName: !GetAtt AppSyncApprovalDbDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/createUncloggerPrompt.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/returnSecondSingleItem.resp.vm"

  UpdateUncloggerPromptResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: updateUncloggerPrompt
      DataSourceName: !GetAtt AppSyncApprovalDbDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/updateUncloggerPromptApproval.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/returnSecondSingleItem.resp.vm"

  DeleteUncloggerPromptResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: deleteUncloggerPrompt
      DataSourceName: !GetAtt AppSyncApprovalDbDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/deleteUncloggerPrompt.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/returnFirstSingleItem.resp.vm"

  # In-type resolvers
  UserOfCommentResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Comment
      FieldName: user
      DataSourceName: !GetAtt AppSyncUserTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/getBySourceUserId.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  FlagsOfCommentResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Comment
      FieldName: flags
      DataSourceName: !GetAtt AppSyncApprovalDbDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/listContentFlags.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/returnList.resp.vm"

  StreamOfLikeResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Like
      FieldName: stream
      DataSourceName: !GetAtt AppSyncStreamTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/getBySourceStreamId.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  CantoOfLikeResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Like
      FieldName: canto
      DataSourceName: !GetAtt AppSyncCantoTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/getBySourceCantoId.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  UserOfStreamResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Stream
      FieldName: user
      DataSourceName: !GetAtt AppSyncUserTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/getBySourceUserId.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  CommentsOfStreamResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Stream
      FieldName: comments
      DataSourceName: !GetAtt AppSyncCommentTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/getCommentsOfStream.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnList.resp.vm"

  LikesOfStreamResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Stream
      FieldName: likes
      DataSourceName: !GetAtt AppSyncLikeTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/getLikesOfStream.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnList.resp.vm"

  LikesOfCantoResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Canto
      FieldName: likes
      DataSourceName: !GetAtt AppSyncLikeTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/getLikesOfCanto.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnList.resp.vm"

  FlagsOfStreamResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Stream
      FieldName: flags
      DataSourceName: !GetAtt AppSyncApprovalDbDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/listContentFlags.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/rds/returnList.resp.vm"

  StreamsOfUserResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: User
      FieldName: streams
      DataSourceName: !GetAtt AppSyncStreamTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/queryBySourceUserId.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  UserInteractionsOfUserResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: User
      FieldName: userInteractions
      DataSourceName: !GetAtt AppSyncUserInteractionTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/queryBySourceUserIdAsActorId.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  TargetUserOfUserInteractionResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: UserInteraction
      FieldName: targetUser
      DataSourceName: !GetAtt AppSyncUserTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/getBySourceTargetUserId.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  CantoOfUserResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: User
      FieldName: canto
      DataSourceName: !GetAtt AppSyncCantoTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/getBySourceIdAsId.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  UserOfCantoResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Canto
      FieldName: user
      DataSourceName: !GetAtt AppSyncUserTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/getBySourceIdAsId.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  FlaggerUserOfFlagResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Flag
      FieldName: flaggerUser
      DataSourceName: !GetAtt AppSyncUserTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/getBySourceFlaggerUserId.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  ReviewerUserOfFlagResolver:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Flag
      FieldName: reviewerUser
      DataSourceName: !GetAtt AppSyncUserTableDataSource.Name
      RequestMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/getBySourceReviewerUserId.req.vm"
      ResponseMappingTemplateS3Location: !Sub "s3://${ResourceBucketName}/graphql/mappings/common/returnSingleItem.resp.vm"

  # API key
  AppSyncApiKey:
    Type: AWS::AppSync::ApiKey
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      # To expire in 2020, May 20th
      Expires: 1590004800
